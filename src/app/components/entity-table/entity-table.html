<!-- my-lazy-table.component.html -->
<!-- <div class="p-grid p-align-end p-mb-2">
  <div class="p-col-12 p-md-4">
    <label for="filterName">Filter by Descr</label>
    <input id="filterName" type="text" pInputText [(ngModel)]="filterValue" placeholder="Enter nameâ€¦" />
  </div>
  <div class="p-col-12 p-md-2">
    <button pButton type="button" label="Apply Filter" (click)="onFilter()"></button>
  </div>
</div> -->

<!-- <div class="flex flex-row items-center justify-between mb-4 p-0">
  <p>Showing <b>{{ items.length }}</b> of <b>{{ totalRecords }}</b> records.</p>
  <div class="flex flex-row items-center justify-end gap-4">
    <p-button size="small" icon="pi pi-file-export" label="Export" />
    <p-button size="small" icon="pi pi-plus" label="Add New" severity="info" (click)="onCreateRow($event)" />
  </div>
</div> -->

<p-toolbar class="mb-4">
  <ng-template #start>
    <div class="flex flex-row items-center justify-between gap-4">
      <p-button text size="small" icon="pi pi-sync" (click)="onRefresh()"></p-button>
      <p-tag severity="info">{{hostId}}</p-tag>
    </div>
  </ng-template>
  <ng-template #center>
    <p>Showing <b>{{ items.length }}</b> of <b>{{ totalRecords }}</b> records.</p>
  </ng-template>
  <ng-template #end>
    <div class="flex flex-row items-center justify-between gap-4">
      <p-splitbutton size="small" severity="info" label="Add New" icon="pi pi-plus" (onClick)="onCreateRow($event)" [model]="_tableActions" />
    </div>
  </ng-template>
</p-toolbar>

<p-table #table 
  size="small"
  stripedRows
  [showGridlines]="false"
  [value]="items" 
  [lazy]="true" 
  (onLazyLoad)="loadItems($event)" 
  [paginator]="true" 
  [rows]="tableSpec.rows"
  [sortField]="tableSpec.defaultSortField"
  [rowsPerPageOptions]="tableSpec.rowsPerPageOptions" 
  [totalRecords]="totalRecords" 
  [loading]="loading" 
  [sortMode]="'single'"
  [reorderableColumns]="true"
  [scrollable]="true"
>
  <ng-template pTemplate="header">
    <tr>
      @if (!tableSpec.disableActions) {
        <th pFrozenColumn style="border-right: 1px solid var(--p-slate-300);"></th>
      }
      
      @for (col of tableSpec.columns; track col.field) {
        @if (!col.hidden) {
          <th pReorderableColumn [pSortableColumn]="col.type != 'image' ? col.field : undefined" [style]="{ 'min-width': (col.type === 'barcode' ? '100px' : '')}">
            <div class="flex flex-row items-center justify-between">
              <div class="flex flex-row items-center gap-2">
                @if (col.type === 'image') {
                } @else {
                  <span style="white-space: pre;">{{col.header}}</span>
                  <p-sortIcon [field]="col.field" />
                }
              </div>
            </div>
          </th>
        }
      }
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-item>
    <tr>
      @if (!tableSpec.disableActions) {
        <td pFrozenColumn style="width: 50px; border-right: 1px solid var(--p-slate-300);">
          <p-buttongroup>
            <p-button text size="small" icon="pi pi-eye" (click)="onViewRow($event, item)"/>
            <p-button text size="small" icon="pi pi-pen-to-square" (click)="onEditRow($event, item)"/>
            <p-button text size="small" icon="pi pi-clone" />
            <p-button text size="small" icon="pi pi-trash" severity="danger" />
          </p-buttongroup>
        </td>
      }

      @for (col of tableSpec.columns; track col.field) {
        @if (!col.hidden) {
          <td [style]="{ 'min-width': (col.type === 'barcode' ? '100px' : '')}">
            @if (col.isPrimaryKey) {
              @if (col.type === 'relation') {
                @if (item[col.field + '__display']) {
                  <p-tag style="width: 100%; white-space: pre;" [severity]="col.color || 'contrast'" [value]="item[col.field + '__display']"></p-tag>
                }
              } @else {
                @if (item[col.field]) {
                  <p-tag style="width: 100%; white-space: pre;" [severity]="col.color || 'contrast'" [value]="item[col.field]"></p-tag>
                }
              }
            } @else {
              @if (col.type === 'boolean') {
                <p-tag style="width: 100%;" [severity]="item[col.field] ? 'success' : 'secondary'" [value]="item[col.field] || false"></p-tag>
              } @else if (col.type === 'date') {
                <span style="white-space: pre;" class="{{col.formatting ? col.formatting.join(' ') : ''}} text-{{col.color}}"><small>{{ item[col.field] | date:'medium' }}</small></span>
              } @else if (col.type === 'image') {
                @if (item[col.field]) {
                  <p-image loading="lazy" src="{{mockDataSvc.imageBuckets[hostId!]}}/{{item[col.field]}}" alt="Image" [preview]="true" style="width: 50px; height: 50px;" />
                }
              } @else if (col.type === 'barcode') {
                @if (item[col.field]) {
                  <p-image loading="lazy" src="http://beta.elvispos.com:7400/barcode/render?code={{item[col.field]}}&type=code128" alt="Image" [preview]="true">
                    <ng-template #preview>
                      <img src="http://beta.elvispos.com:7400/barcode/render?code={{item[col.field]}}&type=code128" alt="image" [style]="{ 'background-color': 'white', 'border': '2rem solid white', 'max-width': '768px'}" />
                    </ng-template>
                  </p-image>
                }
              } @else if (col.type === 'relation') {
                <span style="white-space: pre;" class="{{col.formatting ? col.formatting.join(' ') : ''}} text-{{col.color}}">{{ item[col.field + '__display'] }}</span>
              } @else {
                <span style="white-space: pre;" class="{{col.formatting ? col.formatting.join(' ') : ''}} text-{{col.color}}">{{ item[col.field] }}</span>
              }
            }
          </td>
        }
      }
    </tr>
  </ng-template>
  <!-- <ng-template pTemplate="footer">
    <tr>
      <td [attr.colspan]="tableSpec.columns.length">
        Showing {{ items.length }} of {{ totalRecords }} items.
      </td>
    </tr>
  </ng-template> -->
</p-table>


<p-drawer [(visible)]="showEditTableSpecDrawer" #editTableDrawer header="Edit Table" position="right" styleClass="!w-full md:!w-80 lg:!w-[47.5rem]">
  <app-entity-table-builder [hostId]="hostId!"></app-entity-table-builder>
</p-drawer>

<p-drawer [(visible)]="showRowDrawer" #editTableDrawer [header]="rowDrawerHeader" position="right" styleClass="!w-full md:!w-80 lg:!w-[60rem]">
  <app-entity-form #entityForm [hostId]="hostId!"></app-entity-form>
</p-drawer>